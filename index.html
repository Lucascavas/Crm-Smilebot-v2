<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM White Label - Vers√£o 10</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            width: 100%;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 24px;
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .kanban-column {
            min-height: 400px;
        }
        
        .card-hover {
            transition: all 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            border: 2px dashed #6366f1 !important;
            background: rgba(99, 102, 241, 0.05) !important;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .calendar-day {
            min-height: 100px;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }

        #app-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background: #f8fafc;
        }

        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-loading">
   <div class="loader"></div>
  </div>
  <div id="app" class="h-full w-full flex overflow-auto" style="display: none;"></div>
  <script>
        // Configura√ß√£o padr√£o
        const defaultConfig = {
            primary_color: '#6366f1',
            secondary_surface: '#f8fafc',
            text_color: '#1e293b',
            action_primary: '#6366f1',
            action_secondary: '#64748b',
            font_family: 'Inter',
            font_size: 16,
            company_name: 'Meu CRM',
            welcome_message: 'Bem-vindo ao seu CRM',
            leads_title: 'Pipeline de Vendas',
            contacts_title: 'Gerenciar Contatos',
            tasks_title: 'Minhas Tarefas',
            calendar_title: 'Calend√°rio',
            metrics_title: 'M√©tricas em Tempo Real'
        };

        // Vari√°veis globais
        let currentView = 'dashboard';
        let allRecords = [];
        let showingModal = false;
        let currentEditRecord = null;
        let draggedElement = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let whatsappConnected = false;
        let appInitialized = false;

        // Fun√ß√µes de armazenamento local
        function loadLocalData() {
            try {
                const data = localStorage.getItem('crm_data_v10');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('Erro ao carregar dados:', e);
                return [];
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('crm_data_v10', JSON.stringify(allRecords));
            } catch (e) {
                console.error('Erro ao salvar dados:', e);
            }
        }

        // Inicializar aplica√ß√£o
        function initializeApp() {
            if (appInitialized) return;
            appInitialized = true;

            try {
                // Carregar dados
                allRecords = loadLocalData();
                
                // Esconder loader e mostrar app
                const loader = document.getElementById('app-loading');
                const app = document.getElementById('app');
                
                if (loader) loader.style.display = 'none';
                if (app) app.style.display = 'flex';
                
                // Renderizar aplica√ß√£o
                renderApp();

                // Inicializar SDK se dispon√≠vel
                if (window.elementSdk) {
                    window.elementSdk.init({
                        defaultConfig: defaultConfig,
                        onConfigChange: async (config) => {
                            await applyConfigChanges(config);
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [
                                {
                                    get: () => config.primary_color || defaultConfig.primary_color,
                                    set: (value) => {
                                        config.primary_color = value;
                                        window.elementSdk.setConfig({ primary_color: value });
                                    }
                                },
                                {
                                    get: () => config.secondary_surface || defaultConfig.secondary_surface,
                                    set: (value) => {
                                        config.secondary_surface = value;
                                        window.elementSdk.setConfig({ secondary_surface: value });
                                    }
                                },
                                {
                                    get: () => config.text_color || defaultConfig.text_color,
                                    set: (value) => {
                                        config.text_color = value;
                                        window.elementSdk.setConfig({ text_color: value });
                                    }
                                },
                                {
                                    get: () => config.action_primary || defaultConfig.action_primary,
                                    set: (value) => {
                                        config.action_primary = value;
                                        window.elementSdk.setConfig({ action_primary: value });
                                    }
                                },
                                {
                                    get: () => config.action_secondary || defaultConfig.action_secondary,
                                    set: (value) => {
                                        config.action_secondary = value;
                                        window.elementSdk.setConfig({ action_secondary: value });
                                    }
                                }
                            ],
                            borderables: [],
                            fontEditable: {
                                get: () => config.font_family || defaultConfig.font_family,
                                set: (value) => {
                                    config.font_family = value;
                                    window.elementSdk.setConfig({ font_family: value });
                                }
                            },
                            fontSizeable: {
                                get: () => config.font_size || defaultConfig.font_size,
                                set: (value) => {
                                    config.font_size = value;
                                    window.elementSdk.setConfig({ font_size: value });
                                }
                            }
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ['company_name', config.company_name || defaultConfig.company_name],
                            ['welcome_message', config.welcome_message || defaultConfig.welcome_message],
                            ['leads_title', config.leads_title || defaultConfig.leads_title],
                            ['contacts_title', config.contacts_title || defaultConfig.contacts_title],
                            ['tasks_title', config.tasks_title || defaultConfig.tasks_title],
                            ['calendar_title', config.calendar_title || defaultConfig.calendar_title],
                            ['metrics_title', config.metrics_title || defaultConfig.metrics_title]
                        ])
                    });
                }
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                const app = document.getElementById('app');
                if (app) {
                    app.style.display = 'flex';
                    app.innerHTML = `
                        <div style="padding: 40px; text-align: center; width: 100%;">
                            <h1 style="color: #ef4444; margin-bottom: 20px;">‚ùå Erro ao Carregar</h1>
                            <p style="color: #64748b;">Ocorreu um erro ao inicializar o CRM. Por favor, recarregue a p√°gina.</p>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Recarregar P√°gina
                            </button>
                        </div>
                    `;
                }
                const loader = document.getElementById('app-loading');
                if (loader) loader.style.display = 'none';
            }
        }

        async function applyConfigChanges(config) {
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const surfaceColor = config.secondary_surface || defaultConfig.secondary_surface;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontFamily = config.font_family || defaultConfig.font_family;
            const fontSize = config.font_size || defaultConfig.font_size;

            // Aplicar cores e fontes
            const elements = document.querySelectorAll('[style*="color"], [style*="background"]');
            elements.forEach(el => {
                const style = el.getAttribute('style') || '';
                if (style.includes('color:') && !style.includes('background')) {
                    el.style.color = textColor;
                }
            });

            // Atualizar textos edit√°veis
            const companyNameEl = document.getElementById('company-name');
            if (companyNameEl) companyNameEl.textContent = config.company_name || defaultConfig.company_name;

            const welcomeEl = document.getElementById('welcome-message');
            if (welcomeEl) welcomeEl.textContent = config.welcome_message || defaultConfig.welcome_message;

            // Re-renderizar para aplicar todas as mudan√ßas
            renderApp();
        }

        function renderApp() {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const surfaceColor = config.secondary_surface || defaultConfig.secondary_surface;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontFamily = config.font_family || defaultConfig.font_family;
            const fontSize = config.font_size || defaultConfig.font_size;

            const app = document.getElementById('app');
            if (!app) return;

            app.innerHTML = `
                <div class="flex h-full w-full" style="background: ${surfaceColor}; font-family: ${fontFamily}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div class="w-64 h-full flex flex-col" style="background: white; border-right: 1px solid #e2e8f0;">
                        <div class="p-6 border-b border-gray-200">
                            <h1 id="company-name" class="title-text font-bold" style="color: ${primaryColor}; font-size: ${fontSize * 1.5}px;">
                                ${config.company_name || defaultConfig.company_name}
                            </h1>
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">
                                White Label CRM
                            </p>
                        </div>
                        
                        <nav class="flex-1 p-4 overflow-y-auto">
                            <button onclick="changeView('dashboard')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'dashboard' ? primaryColor : 'transparent'}; color: ${currentView === 'dashboard' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üìä Dashboard
                            </button>
                            <button onclick="changeView('metrics')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'metrics' ? primaryColor : 'transparent'}; color: ${currentView === 'metrics' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üìà ${config.metrics_title || defaultConfig.metrics_title}
                            </button>
                            <button onclick="changeView('leads')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'leads' ? primaryColor : 'transparent'}; color: ${currentView === 'leads' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üéØ ${config.leads_title || defaultConfig.leads_title}
                            </button>
                            <button onclick="changeView('calendar')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'calendar' ? primaryColor : 'transparent'}; color: ${currentView === 'calendar' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üìÖ ${config.calendar_title || defaultConfig.calendar_title}
                            </button>
                            <button onclick="changeView('contacts')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'contacts' ? primaryColor : 'transparent'}; color: ${currentView === 'contacts' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üë• ${config.contacts_title || defaultConfig.contacts_title}
                            </button>
                            <button onclick="changeView('tasks')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'tasks' ? primaryColor : 'transparent'}; color: ${currentView === 'tasks' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                ‚úì ${config.tasks_title || defaultConfig.tasks_title}
                            </button>
                            <button onclick="changeView('automation')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'automation' ? primaryColor : 'transparent'}; color: ${currentView === 'automation' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                ‚ö° Automa√ß√£o
                            </button>
                        </nav>
                        
                        <div class="p-4 border-t border-gray-200">
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">
                                üíº Plano: Professional
                            </p>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col h-full overflow-hidden">
                        <div class="p-6 border-b border-gray-200" style="background: white;">
                            <h2 id="welcome-message" class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                                ${config.welcome_message || defaultConfig.welcome_message}
                            </h2>
                        </div>

                        <div id="content-area" class="flex-1 overflow-auto p-6">
                        </div>
                    </div>
                </div>
            `;

            updateCurrentView();
        }

        function changeView(view) {
            currentView = view;
            renderApp();
        }

        function updateCurrentView() {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;

            switch (currentView) {
                case 'dashboard':
                    renderDashboard(contentArea);
                    break;
                case 'metrics':
                    renderMetrics(contentArea);
                    break;
                case 'leads':
                    renderLeadsDragDrop(contentArea);
                    break;
                case 'calendar':
                    renderCalendar(contentArea);
                    break;
                case 'contacts':
                    renderContacts(contentArea);
                    break;
                case 'tasks':
                    renderTasks(contentArea);
                    break;
                case 'automation':
                    renderAutomation(contentArea);
                    break;
            }
        }

        function renderDashboard(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const totalLeads = allRecords.filter(r => r.type === 'lead').length;
            const totalContacts = allRecords.filter(r => r.type === 'contact').length;
            const totalTasks = allRecords.filter(r => r.type === 'task').length;
            const completedTasks = allRecords.filter(r => r.type === 'task' && r.status === 'completed').length;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Total de Leads</span>
                            <span class="text-2xl">üéØ</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${totalLeads}</p>
                    </div>
                    
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Contatos</span>
                            <span class="text-2xl">üë•</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${totalContacts}</p>
                    </div>
                    
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Tarefas</span>
                            <span class="text-2xl">‚úì</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${totalTasks}</p>
                    </div>
                    
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Conclu√≠das</span>
                            <span class="text-2xl">‚úîÔ∏è</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${completedTasks}</p>
                    </div>
                </div>

                <div class="p-6 rounded-lg" style="background: white; border: 1px solid #e2e8f0;">
                    <h3 class="subtitle-text font-semibold mb-4" style="color: ${textColor}; font-size: ${fontSize * 1.125}px;">Atividade Recente</h3>
                    <div id="recent-activity" class="space-y-3">
                        ${allRecords.length > 0 ? allRecords.slice(-5).reverse().map(record => `
                            <div class="flex items-center justify-between p-3 rounded" style="background: #f8fafc;">
                                <div>
                                    <p class="body-text font-medium" style="color: ${textColor}; font-size: ${fontSize}px;">${record.name}</p>
                                    <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${record.type === 'lead' ? 'üéØ Lead' : record.type === 'contact' ? 'üë• Contato' : '‚úì Tarefa'}</p>
                                </div>
                                <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${new Date(record.createdAt).toLocaleDateString('pt-BR')}</span>
                            </div>
                        `).join('') : `<p class="body-text text-center py-8" style="color: #94a3b8; font-size: ${fontSize}px;">Nenhuma atividade recente. Clique em um dos menus para come√ßar!</p>`}
                    </div>
                </div>
            `;
        }

        function renderMetrics(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const leads = allRecords.filter(r => r.type === 'lead');
            const newLeads = leads.filter(l => l.stage === 'new').length;
            const qualifiedLeads = leads.filter(l => l.stage === 'qualified').length;
            const wonLeads = leads.filter(l => l.stage === 'won').length;
            const totalValue = leads.reduce((sum, l) => sum + (l.value || 0), 0);

            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="subtitle-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                        üìà ${config.metrics_title || defaultConfig.metrics_title}
                    </h3>
                    <p class="body-text" style="color: #64748b; font-size: ${fontSize}px;">Acompanhe o desempenho do seu neg√≥cio</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Novos Leads</span>
                            <span class="text-2xl">üéØ</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">${newLeads}</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚ÜóÔ∏è Pipeline ativo</p>
                    </div>

                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Qualificados</span>
                            <span class="text-2xl">‚úÖ</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">${qualifiedLeads}</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚ÜóÔ∏è Em negocia√ß√£o</p>
                    </div>

                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Ganhos</span>
                            <span class="text-2xl">üèÜ</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">${wonLeads}</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚úì Vendas fechadas</p>
                    </div>

                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Receita Total</span>
                            <span class="text-2xl">üí∞</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">R$ ${(totalValue/1000).toFixed(0)}k</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚ÜóÔ∏è Pipeline value</p>
                    </div>
                </div>
            `;
        }

        function renderLeadsDragDrop(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const leads = allRecords.filter(r => r.type === 'lead');
            const stages = ['new', 'contacted', 'qualified', 'proposal', 'won'];
            const stageNames = {
                'new': 'Novo',
                'contacted': 'Contatado',
                'qualified': 'Qualificado',
                'proposal': 'Proposta',
                'won': 'Ganho'
            };

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <h3 class="subtitle-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                            üéØ ${config.leads_title || defaultConfig.leads_title}
                        </h3>
                        <p class="body-text" style="color: #64748b; font-size: ${fontSize}px;">Arraste os cards para mudar de est√°gio</p>
                    </div>
                    <button onclick="openModal('lead')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Novo Lead
                    </button>
                </div>

                <div class="flex gap-4 overflow-x-auto pb-4">
                    ${stages.map(stage => {
                        const stageLeads = leads.filter(l => l.stage === stage);
                        const stageValue = stageLeads.reduce((sum, l) => sum + (l.value || 0), 0);
                        return `
                            <div class="flex-shrink-0 w-80">
                                <div class="p-4 rounded-lg mb-3" style="background: white; border: 1px solid #e2e8f0;">
                                    <h4 class="body-text font-semibold mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">${stageNames[stage]}</h4>
                                    <div class="flex items-center justify-between">
                                        <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${stageLeads.length} leads</p>
                                        <p class="small-text font-semibold" style="color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">R$ ${(stageValue/1000).toFixed(0)}k</p>
                                    </div>
                                </div>
                                <div 
                                    class="kanban-column space-y-3 p-3 rounded-lg min-h-96" 
                                    style="background: #f8fafc; border: 2px dashed transparent; transition: all 0.3s;"
                                    data-stage="${stage}"
                                    ondragover="handleDragOver(event)"
                                    ondragleave="handleDragLeave(event)"
                                    ondrop="handleDrop(event, '${stage}')"
                                >
                                    ${stageLeads.map(lead => `
                                        <div 
                                            class="lead-card p-4 rounded-lg card-hover cursor-move" 
                                            style="background: white; border: 1px solid #e2e8f0;"
                                            draggable="true"
                                            data-lead-id="${lead.id}"
                                            ondragstart="handleDragStart(event, '${lead.id}')"
                                            ondragend="handleDragEnd(event)"
                                        >
                                            <div class="flex items-start justify-between mb-2">
                                                <h5 class="body-text font-medium flex-1" style="color: ${textColor}; font-size: ${fontSize}px;">${lead.name}</h5>
                                                <button onclick="event.stopPropagation(); openEditModal('${lead.id}')" class="text-sm px-2 py-1 rounded" style="color: #64748b; background: #f8fafc; font-size: ${fontSize * 0.875}px;">
                                                    ‚öôÔ∏è
                                                </button>
                                            </div>
                                            <p class="small-text mb-2" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${lead.company || 'Sem empresa'}</p>
                                            ${lead.value ? `<p class="small-text font-semibold" style="color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">üí∞ R$ ${lead.value.toLocaleString('pt-BR')}</p>` : ''}
                                            <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-between">
                                                <span class="small-text" style="color: #94a3b8; font-size: ${fontSize * 0.75}px;">üñêÔ∏è Arraste para mover</span>
                                            </div>
                                        </div>
                                    `).join('') || `<p class="text-center text-sm py-8" style="color: #94a3b8; font-size: ${fontSize * 0.875}px;">Nenhum lead<br/>Arraste cards aqui</p>`}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Fun√ß√µes de Drag and Drop
        let draggedLeadId = null;

        function handleDragStart(event, leadId) {
            draggedLeadId = leadId;
            event.currentTarget.classList.add('dragging');
            event.currentTarget.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            event.currentTarget.style.opacity = '1';
            
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.style.border = '2px dashed transparent';
                col.style.background = '#f8fafc';
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const column = event.currentTarget;
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            column.style.border = `2px dashed ${primaryColor}`;
            column.style.background = 'rgba(99, 102, 241, 0.05)';
        }

        function handleDragLeave(event) {
            const column = event.currentTarget;
            column.style.border = '2px dashed transparent';
            column.style.background = '#f8fafc';
        }

        function handleDrop(event, newStage) {
            event.preventDefault();
            
            if (!draggedLeadId) return;
            
            const leadIndex = allRecords.findIndex(r => r.id === draggedLeadId);
            if (leadIndex === -1) return;
            
            const lead = allRecords[leadIndex];
            const oldStage = lead.stage;
            
            lead.stage = newStage;
            lead.updatedAt = new Date().toISOString();
            
            saveLocalData();
            
            const column = event.currentTarget;
            column.style.border = '2px dashed transparent';
            column.style.background = '#f8fafc';
            
            const stageNames = {
                'new': 'Novo',
                'contacted': 'Contatado',
                'qualified': 'Qualificado',
                'proposal': 'Proposta',
                'won': 'Ganho'
            };
            
            if (oldStage !== newStage) {
                showToast(`Lead movido para "${stageNames[newStage]}"! üéØ`, 'success');
            }
            
            updateCurrentView();
            
            draggedLeadId = null;
        }

        function renderCalendar(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            container.innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                            üìÖ ${config.calendar_title || defaultConfig.calendar_title}
                        </h3>
                        <button onclick="openModal('task')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                            + Nova Tarefa
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 rounded-lg mb-4" style="background: white; border: 1px solid #e2e8f0;">
                        <button onclick="changeMonth(-1)" class="p-2 rounded" style="color: ${textColor}; font-size: ${fontSize}px;">
                            ‚Üê Anterior
                        </button>
                        <h4 class="body-text font-bold" style="color: ${primaryColor}; font-size: ${fontSize}px;">${monthNames[currentMonth]} ${currentYear}</h4>
                        <button onclick="changeMonth(1)" class="p-2 rounded" style="color: ${textColor}; font-size: ${fontSize}px;">
                            Pr√≥ximo ‚Üí
                        </button>
                    </div>
                </div>

                <div class="rounded-lg overflow-hidden" style="background: white; border: 1px solid #e2e8f0;">
                    <div class="calendar-grid" style="background: #f8fafc;">
                        ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].map(day => `
                            <div class="p-4 text-center body-text font-semibold" style="color: ${textColor}; background: white; border-bottom: 2px solid ${primaryColor}; font-size: ${fontSize}px;">
                                ${day}
                            </div>
                        `).join('')}
                    </div>

                    <div class="calendar-grid">
                        ${Array.from({ length: startingDayOfWeek }, () => `
                            <div class="calendar-day p-2" style="background: #f8fafc; border: 1px solid #e2e8f0;"></div>
                        `).join('')}
                        
                        ${Array.from({ length: daysInMonth }, (_, i) => {
                            const day = i + 1;
                            const date = new Date(currentYear, currentMonth, day);
                            const isToday = date.toDateString() === new Date().toDateString();
                            
                            return `
                                <div class="calendar-day p-2" style="background: white; border: 1px solid #e2e8f0; ${isToday ? `border: 2px solid ${primaryColor};` : ''}">
                                    <span class="small-text font-semibold" style="color: ${isToday ? primaryColor : textColor}; font-size: ${fontSize * 0.875}px;">${day}</span>
                                    ${isToday ? `<span class="small-text px-2 py-1 rounded ml-1" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 0.625}px;">Hoje</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCurrentView();
        }

        function renderContacts(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const contacts = allRecords.filter(r => r.type === 'contact');

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                        üë• ${config.contacts_title || defaultConfig.contacts_title}
                    </h3>
                    <button onclick="openModal('contact')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Novo Contato
                    </button>
                </div>

                <div class="rounded-lg overflow-hidden" style="background: white; border: 1px solid #e2e8f0;">
                    <table class="w-full">
                        <thead style="background: #f8fafc;">
                            <tr>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">Nome</th>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">Email</th>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">Telefone</th>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${contacts.map(contact => `
                                <tr class="border-t border-gray-200">
                                    <td class="p-4 body-text" style="color: ${textColor}; font-size: ${fontSize}px;">${contact.name}</td>
                                    <td class="p-4 small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${contact.email || '-'}</td>
                                    <td class="p-4 small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${contact.phone || '-'}</td>
                                    <td class="p-4">
                                        <button onclick="openEditModal('${contact.id}')" class="px-3 py-1 rounded small-text" style="background: #f8fafc; color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                                            Editar
                                        </button>
                                    </td>
                                </tr>
                            `).join('') || `
                                <tr>
                                    <td colspan="4" class="p-8 text-center body-text" style="color: #94a3b8; font-size: ${fontSize}px;">
                                        Nenhum contato cadastrado. Clique em "+ Novo Contato" para come√ßar!
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderTasks(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const tasks = allRecords.filter(r => r.type === 'task');
            const pendingTasks = tasks.filter(t => t.status !== 'completed');
            const completedTasks = tasks.filter(t => t.status === 'completed');

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                        ‚úì ${config.tasks_title || defaultConfig.tasks_title}
                    </h3>
                    <button onclick="openModal('task')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Nova Tarefa
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="p-6 rounded-lg" style="background: white; border: 1px solid #e2e8f0;">
                        <h4 class="body-text font-semibold mb-4" style="color: ${textColor}; font-size: ${fontSize}px;">Pendentes (${pendingTasks.length})</h4>
                        <div class="space-y-3">
                            ${pendingTasks.map(task => `
                                <div class="p-4 rounded-lg" style="background: #f8fafc;">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h5 class="body-text font-medium mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">${task.name}</h5>
                                            ${task.notes ? `<p class="small-text mb-2" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${task.notes}</p>` : ''}
                                            <span class="small-text px-2 py-1 rounded" style="background: ${task.priority === 'high' ? '#fee2e2' : task.priority === 'medium' ? '#fef3c7' : '#f0f9ff'}; color: ${task.priority === 'high' ? '#991b1b' : task.priority === 'medium' ? '#92400e' : '#1e40af'}; font-size: ${fontSize * 0.75}px;">
                                                ${task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'M√©dia' : 'Baixa'}
                                            </span>
                                        </div>
                                        <button onclick="completeTask('${task.id}')" class="ml-3 px-3 py-1 rounded small-text" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 0.875}px;">
                                            Concluir
                                        </button>
                                    </div>
                                </div>
                            `).join('') || `<p class="body-text text-center py-8" style="color: #94a3b8; font-size: ${fontSize}px;">Nenhuma tarefa pendente</p>`}
                        </div>
                    </div>

                    <div class="p-6 rounded-lg" style="background: white; border: 1px solid #e2e8f0;">
                        <h4 class="body-text font-semibold mb-4" style="color: ${textColor}; font-size: ${fontSize}px;">Conclu√≠das (${completedTasks.length})</h4>
                        <div class="space-y-3">
                            ${completedTasks.map(task => `
                                <div class="p-4 rounded-lg" style="background: #f8fafc; opacity: 0.7;">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h5 class="body-text font-medium line-through mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">${task.name}</h5>
                                        </div>
                                        <span class="ml-3 text-xl">‚úì</span>
                                    </div>
                                </div>
                            `).join('') || `<p class="body-text text-center py-8" style="color: #94a3b8; font-size: ${fontSize}px;">Nenhuma tarefa conclu√≠da</p>`}
                        </div>
                    </div>
                </div>
            `;
        }

        function completeTask(id) {
            const task = allRecords.find(r => r.id === id);
            if (!task) return;

            task.status = 'completed';
            task.updatedAt = new Date().toISOString();
            
            saveLocalData();
            showToast('Tarefa conclu√≠da!', 'success');
            updateCurrentView();
        }

        function renderAutomation(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const automations = allRecords.filter(r => r.type === 'automation');

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <h3 class="subtitle-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                            ‚ö° Automa√ß√£o WhatsApp
                        </h3>
                        <p class="body-text" style="color: #64748b; font-size: ${fontSize}px;">Configure mensagens autom√°ticas via WhatsApp</p>
                    </div>
                    <button onclick="openModal('automation')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Nova Automa√ß√£o
                    </button>
                </div>

                <div class="mb-8 p-6 rounded-lg" style="background: white; border: 2px solid #e2e8f0;">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-4xl">üì±</span>
                        <div>
                            <h4 class="body-text font-semibold mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">WhatsApp Business (Demo)</h4>
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Interface de demonstra√ß√£o - Backend necess√°rio para produ√ß√£o</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    ${automations.map(auto => `
                        <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h5 class="body-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize}px;">${auto.name}</h5>
                                    <p class="small-text mb-3" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${auto.notes || 'Sem descri√ß√£o'}</p>
                                    <div class="flex gap-4">
                                        <span class="small-text" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;"><strong>Gatilho:</strong> ${auto.trigger}</span>
                                        <span class="small-text" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;"><strong>A√ß√£o:</strong> ${auto.action}</span>
                                    </div>
                                </div>
                                <button onclick="deleteRecord('${auto.id}')" class="px-3 py-1 rounded small-text" style="background: #fee2e2; color: #991b1b; font-size: ${fontSize * 0.875}px;">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `).join('') || `
                        <div class="p-12 rounded-lg text-center" style="background: white; border: 1px solid #e2e8f0;">
                            <span class="text-6xl mb-4 block">‚ö°</span>
                            <p class="body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;">Nenhuma automa√ß√£o criada</p>
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Crie sua primeira automa√ß√£o de WhatsApp</p>
                        </div>
                    `}
                </div>
            `;
        }

        function openModal(type) {
            currentEditRecord = null;
            renderModal(type);
        }

        function openEditModal(id) {
            currentEditRecord = allRecords.find(r => r.id === id);
            if (!currentEditRecord) return;
            renderModal(currentEditRecord.type);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.remove();
        }

        function renderModal(type) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const isEdit = currentEditRecord !== null;
            const record = currentEditRecord || {};

            const modalTitle = isEdit ? 
                (type === 'lead' ? 'Editar Lead' : type === 'contact' ? 'Editar Contato' : type === 'task' ? 'Editar Tarefa' : 'Editar Automa√ß√£o') :
                (type === 'lead' ? 'Novo Lead' : type === 'contact' ? 'Novo Contato' : type === 'task' ? 'Nova Tarefa' : 'Nova Automa√ß√£o');

            const existingModal = document.getElementById('modal');
            if (existingModal) existingModal.remove();

            let formFields = '';

            if (type === 'automation') {
                formFields = `
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="name">Nome da Automa√ß√£o</label>
                        <input type="text" id="name" required value="${record.name || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                    </div>
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="trigger">Gatilho</label>
                        <select id="trigger" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                            <option value="Novo lead criado" ${record.trigger === 'Novo lead criado' ? 'selected' : ''}>Novo lead criado</option>
                            <option value="Lead muda de est√°gio" ${record.trigger === 'Lead muda de est√°gio' ? 'selected' : ''}>Lead muda de est√°gio</option>
                            <option value="Contato criado" ${record.trigger === 'Contato criado' ? 'selected' : ''}>Contato criado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="action">A√ß√£o</label>
                        <select id="action" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                            <option value="Enviar WhatsApp" ${record.action === 'Enviar WhatsApp' ? 'selected' : ''}>Enviar WhatsApp</option>
                            <option value="Enviar email" ${record.action === 'Enviar email' ? 'selected' : ''}>Enviar email</option>
                        </select>
                    </div>
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="notes">Descri√ß√£o</label>
                        <textarea id="notes" rows="3" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">${record.notes || ''}</textarea>
                    </div>
                `;
            } else {
                formFields = `
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="name">Nome</label>
                        <input type="text" id="name" required value="${record.name || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                    </div>

                    ${type !== 'task' ? `
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="email">Email</label>
                            <input type="email" id="email" value="${record.email || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="phone">Telefone</label>
                            <input type="tel" id="phone" value="${record.phone || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="company">Empresa</label>
                            <input type="text" id="company" value="${record.company || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                    ` : ''}

                    ${type === 'lead' ? `
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="value">Valor (R$)</label>
                            <input type="number" id="value" value="${record.value || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="stage">Est√°gio</label>
                            <select id="stage" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                                <option value="new" ${record.stage === 'new' ? 'selected' : ''}>Novo</option>
                                <option value="contacted" ${record.stage === 'contacted' ? 'selected' : ''}>Contatado</option>
                                <option value="qualified" ${record.stage === 'qualified' ? 'selected' : ''}>Qualificado</option>
                                <option value="proposal" ${record.stage === 'proposal' ? 'selected' : ''}>Proposta</option>
                                <option value="won" ${record.stage === 'won' ? 'selected' : ''}>Ganho</option>
                            </select>
                        </div>
                    ` : ''}

                    ${type === 'task' ? `
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="priority">Prioridade</label>
                            <select id="priority" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                                <option value="low" ${record.priority === 'low' ? 'selected' : ''}>Baixa</option>
                                <option value="medium" ${record.priority === 'medium' ? 'selected' : ''}>M√©dia</option>
                                <option value="high" ${record.priority === 'high' ? 'selected' : ''}>Alta</option>
                            </select>
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="dueDate">Data de Vencimento</label>
                            <input type="date" id="dueDate" value="${record.dueDate ? new Date(record.dueDate).toISOString().split('T')[0] : ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                    ` : ''}

                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="notes">Observa√ß√µes</label>
                        <textarea id="notes" rows="3" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">${record.notes || ''}</textarea>
                    </div>
                `;
            }

            const modalHTML = `
                <div id="modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4" style="z-index: 1000;" onclick="if(event.target.id==='modal') closeModal()">
                    <div class="rounded-lg p-6 w-full max-w-md slide-in" style="background: white; max-height: 90%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.125}px;">${modalTitle}</h3>
                            <button onclick="closeModal()" class="text-2xl" style="color: #64748b;">&times;</button>
                        </div>

                        <form id="record-form" class="space-y-4" onsubmit="event.preventDefault(); saveRecord('${type}');">
                            ${formFields}

                            <div class="flex gap-3 pt-4">
                                ${isEdit ? `
                                    <button type="button" onclick="deleteRecord('${record.id}')" class="px-4 py-2 rounded-lg body-text" style="background: #fee2e2; color: #991b1b; font-size: ${fontSize}px;">
                                        Excluir
                                    </button>
                                ` : ''}
                                <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 rounded-lg body-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize}px;">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                                    ${isEdit ? 'Salvar' : 'Criar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function saveRecord(type) {
            const formData = {
                type,
                id: currentEditRecord?.id || `${type}_${Date.now()}`,
                name: document.getElementById('name').value,
                email: document.getElementById('email')?.value || '',
                phone: document.getElementById('phone')?.value || '',
                company: document.getElementById('company')?.value || '',
                value: parseFloat(document.getElementById('value')?.value) || 0,
                stage: document.getElementById('stage')?.value || 'new',
                priority: document.getElementById('priority')?.value || 'medium',
                notes: document.getElementById('notes').value,
                status: 'active',
                dueDate: document.getElementById('dueDate')?.value ? new Date(document.getElementById('dueDate').value).toISOString() : '',
                trigger: document.getElementById('trigger')?.value || '',
                action: document.getElementById('action')?.value || '',
                createdAt: currentEditRecord?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (currentEditRecord) {
                const index = allRecords.findIndex(r => r.id === currentEditRecord.id);
                if (index !== -1) {
                    allRecords[index] = formData;
                }
            } else {
                allRecords.push(formData);
            }

            saveLocalData();
            showToast(currentEditRecord ? 'Registro atualizado!' : 'Registro criado!', 'success');
            closeModal();
            updateCurrentView();
        }

        function deleteRecord(id) {
            allRecords = allRecords.filter(r => r.id !== id);
            saveLocalData();
            showToast('Registro exclu√≠do', 'success');
            closeModal();
            updateCurrentView();
        }

        function showToast(message, type = 'success') {
            const bgColor = type === 'success' ? '#10b981' : '#ef4444';
            const config = window.elementSdk?.config || defaultConfig;
            const fontSize = config.font_size || defaultConfig.font_size;
            
            const toast = document.createElement('div');
            toast.className = 'toast body-text';
            toast.style.background = bgColor;
            toast.style.color = 'white';
            toast.style.fontSize = `${fontSize}px`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Sistema de inicializa√ß√£o m√∫ltiplo para garantir carregamento
        let initAttempts = 0;
        const maxAttempts = 3;

        function tryInit() {
            if (appInitialized) return;
            
            initAttempts++;
            
            try {
                initializeApp();
            } catch (error) {
                console.error(`Tentativa ${initAttempts} falhou:`, error);
                
                if (initAttempts < maxAttempts) {
                    setTimeout(tryInit, 100);
                } else {
                    // Mostrar erro ap√≥s todas as tentativas
                    const loader = document.getElementById('app-loading');
                    const app = document.getElementById('app');
                    
                    if (loader) loader.style.display = 'none';
                    if (app) {
                        app.style.display = 'flex';
                        app.innerHTML = `
                            <div style="padding: 40px; text-align: center; width: 100%;">
                                <h1 style="color: #ef4444; margin-bottom: 20px;">‚ùå Erro ao Carregar</h1>
                                <p style="color: #64748b; margin-bottom: 20px;">O CRM n√£o conseguiu inicializar ap√≥s ${maxAttempts} tentativas.</p>
                                <button onclick="location.reload()" style="padding: 12px 24px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                    üîÑ Recarregar P√°gina
                                </button>
                            </div>
                        `;
                    }
                }
            }
        }

        // M√∫ltiplos pontos de inicializa√ß√£o
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryInit);
        } else {
            tryInit();
        }

        window.addEventListener('load', tryInit);
        
        // Fallback final ap√≥s 2 segundos
        setTimeout(tryInit, 2000);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b7d795fb751f1db',t:'MTc2NzM5MDY0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
