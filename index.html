<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM White Label - Vers√£o 10</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            width: 100%;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 24px;
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .kanban-column {
            min-height: 400px;
        }
        
        .card-hover {
            transition: all 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            border: 2px dashed #6366f1 !important;
            background: rgba(99, 102, 241, 0.05) !important;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .calendar-day {
            min-height: 100px;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }

        #app-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background: #f8fafc;
        }

        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-loading">
   <div class="loader"></div>
  </div>
  <div id="app" class="h-full w-full flex overflow-auto" style="display: none;"></div>
  <script>
        // Configura√ß√£o padr√£o
        const defaultConfig = {
            primary_color: '#6366f1',
            secondary_surface: '#f8fafc',
            text_color: '#1e293b',
            action_primary: '#6366f1',
            action_secondary: '#64748b',
            font_family: 'Inter',
            font_size: 16,
            company_name: 'Meu CRM',
            welcome_message: 'Bem-vindo ao seu CRM',
            leads_title: 'Pipeline de Vendas',
            contacts_title: 'Gerenciar Contatos',
            tasks_title: 'Minhas Tarefas',
            calendar_title: 'Calend√°rio',
            metrics_title: 'M√©tricas em Tempo Real'
        };

        // Vari√°veis globais
        let currentView = 'dashboard';
        let allRecords = [];
        let showingModal = false;
        let currentEditRecord = null;
        let draggedElement = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let whatsappConnected = false;
        let appInitialized = false;

        // Fun√ß√µes de armazenamento local
        function loadLocalData() {
            try {
                const data = localStorage.getItem('crm_data_v10');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('Erro ao carregar dados:', e);
                return [];
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('crm_data_v10', JSON.stringify(allRecords));
            } catch (e) {
                console.error('Erro ao salvar dados:', e);
            }
        }

        // Inicializar aplica√ß√£o
        function initializeApp() {
            if (appInitialized) return;
            appInitialized = true;

            try {
                // Carregar dados
                allRecords = loadLocalData();
                
                // Esconder loader e mostrar app
                const loader = document.getElementById('app-loading');
                const app = document.getElementById('app');
                
                if (loader) loader.style.display = 'none';
                if (app) app.style.display = 'flex';
                
                // Renderizar aplica√ß√£o
                renderApp();

                // Inicializar SDK se dispon√≠vel
                if (window.elementSdk) {
                    window.elementSdk.init({
                        defaultConfig: defaultConfig,
                        onConfigChange: async (config) => {
                            await applyConfigChanges(config);
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [
                                {
                                    get: () => config.primary_color || defaultConfig.primary_color,
                                    set: (value) => {
                                        config.primary_color = value;
                                        window.elementSdk.setConfig({ primary_color: value });
                                    }
                                },
                                {
                                    get: () => config.secondary_surface || defaultConfig.secondary_surface,
                                    set: (value) => {
                                        config.secondary_surface = value;
                                        window.elementSdk.setConfig({ secondary_surface: value });
                                    }
                                },
                                {
                                    get: () => config.text_color || defaultConfig.text_color,
                                    set: (value) => {
                                        config.text_color = value;
                                        window.elementSdk.setConfig({ text_color: value });
                                    }
                                },
                                {
                                    get: () => config.action_primary || defaultConfig.action_primary,
                                    set: (value) => {
                                        config.action_primary = value;
                                        window.elementSdk.setConfig({ action_primary: value });
                                    }
                                },
                                {
                                    get: () => config.action_secondary || defaultConfig.action_secondary,
                                    set: (value) => {
                                        config.action_secondary = value;
                                        window.elementSdk.setConfig({ action_secondary: value });
                                    }
                                }
                            ],
                            borderables: [],
                            fontEditable: {
                                get: () => config.font_family || defaultConfig.font_family,
                                set: (value) => {
                                    config.font_family = value;
                                    window.elementSdk.setConfig({ font_family: value });
                                }
                            },
                            fontSizeable: {
                                get: () => config.font_size || defaultConfig.font_size,
                                set: (value) => {
                                    config.font_size = value;
                                    window.elementSdk.setConfig({ font_size: value });
                                }
                            }
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ['company_name', config.company_name || defaultConfig.company_name],
                            ['welcome_message', config.welcome_message || defaultConfig.welcome_message],
                            ['leads_title', config.leads_title || defaultConfig.leads_title],
                            ['contacts_title', config.contacts_title || defaultConfig.contacts_title],
                            ['tasks_title', config.tasks_title || defaultConfig.tasks_title],
                            ['calendar_title', config.calendar_title || defaultConfig.calendar_title],
                            ['metrics_title', config.metrics_title || defaultConfig.metrics_title]
                        ])
                    });
                }
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                const app = document.getElementById('app');
                if (app) {
                    app.style.display = 'flex';
                    app.innerHTML = `
                        <div style="padding: 40px; text-align: center; width: 100%;">
                            <h1 style="color: #ef4444; margin-bottom: 20px;">‚ùå Erro ao Carregar</h1>
                            <p style="color: #64748b;">Ocorreu um erro ao inicializar o CRM. Por favor, recarregue a p√°gina.</p>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Recarregar P√°gina
                            </button>
                        </div>
                    `;
                }
                const loader = document.getElementById('app-loading');
                if (loader) loader.style.display = 'none';
            }
        }

        async function applyConfigChanges(config) {
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const surfaceColor = config.secondary_surface || defaultConfig.secondary_surface;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontFamily = config.font_family || defaultConfig.font_family;
            const fontSize = config.font_size || defaultConfig.font_size;

            // Aplicar cores e fontes
            const elements = document.querySelectorAll('[style*="color"], [style*="background"]');
            elements.forEach(el => {
                const style = el.getAttribute('style') || '';
                if (style.includes('color:') && !style.includes('background')) {
                    el.style.color = textColor;
                }
            });

            // Atualizar textos edit√°veis
            const companyNameEl = document.getElementById('company-name');
            if (companyNameEl) companyNameEl.textContent = config.company_name || defaultConfig.company_name;

            const welcomeEl = document.getElementById('welcome-message');
            if (welcomeEl) welcomeEl.textContent = config.welcome_message || defaultConfig.welcome_message;

            // Re-renderizar para aplicar todas as mudan√ßas
            renderApp();
        }

        function renderApp() {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const surfaceColor = config.secondary_surface || defaultConfig.secondary_surface;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontFamily = config.font_family || defaultConfig.font_family;
            const fontSize = config.font_size || defaultConfig.font_size;

            const app = document.getElementById('app');
            if (!app) return;

            app.innerHTML = `
                <div class="flex h-full w-full" style="background: ${surfaceColor}; font-family: ${fontFamily}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div class="w-64 h-full flex flex-col" style="background: white; border-right: 1px solid #e2e8f0;">
                        <div class="p-6 border-b border-gray-200">
                            <h1 id="company-name" class="title-text font-bold" style="color: ${primaryColor}; font-size: ${fontSize * 1.5}px;">
                                ${config.company_name || defaultConfig.company_name}
                            </h1>
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">
                                White Label CRM
                            </p>
                        </div>
                        
                        <nav class="flex-1 p-4 overflow-y-auto">
                            <button onclick="changeView('dashboard')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'dashboard' ? primaryColor : 'transparent'}; color: ${currentView === 'dashboard' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üìä Dashboard
                            </button>
                            <button onclick="changeView('metrics')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'metrics' ? primaryColor : 'transparent'}; color: ${currentView === 'metrics' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üìà ${config.metrics_title || defaultConfig.metrics_title}
                            </button>
                            <button onclick="changeView('leads')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'leads' ? primaryColor : 'transparent'}; color: ${currentView === 'leads' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üéØ ${config.leads_title || defaultConfig.leads_title}
                            </button>
                            <button onclick="changeView('calendar')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'calendar' ? primaryColor : 'transparent'}; color: ${currentView === 'calendar' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üìÖ ${config.calendar_title || defaultConfig.calendar_title}
                            </button>
                            <button onclick="changeView('contacts')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'contacts' ? primaryColor : 'transparent'}; color: ${currentView === 'contacts' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                üë• ${config.contacts_title || defaultConfig.contacts_title}
                            </button>
                            <button onclick="changeView('tasks')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'tasks' ? primaryColor : 'transparent'}; color: ${currentView === 'tasks' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                ‚úì ${config.tasks_title || defaultConfig.tasks_title}
                            </button>
                            <button onclick="changeView('automation')" class="nav-item w-full text-left p-3 rounded-lg mb-2 body-text" style="background: ${currentView === 'automation' ? primaryColor : 'transparent'}; color: ${currentView === 'automation' ? 'white' : textColor}; font-size: ${fontSize}px;">
                                ‚ö° Automa√ß√£o
                            </button>
                        </nav>
                        
                        <div class="p-4 border-t border-gray-200">
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">
                                üíº Plano: Professional
                            </p>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col h-full overflow-hidden">
                        <div class="p-6 border-b border-gray-200" style="background: white;">
                            <h2 id="welcome-message" class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                                ${config.welcome_message || defaultConfig.welcome_message}
                            </h2>
                        </div>

                        <div id="content-area" class="flex-1 overflow-auto p-6">
                        </div>
                    </div>
                </div>
            `;

            updateCurrentView();
        }

        function changeView(view) {
            currentView = view;
            renderApp();
        }

        function updateCurrentView() {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;

            switch (currentView) {
                case 'dashboard':
                    renderDashboard(contentArea);
                    break;
                case 'metrics':
                    renderMetrics(contentArea);
                    break;
                case 'leads':
                    renderLeadsDragDrop(contentArea);
                    break;
                case 'calendar':
                    renderCalendar(contentArea);
                    break;
                case 'contacts':
                    renderContacts(contentArea);
                    break;
                case 'tasks':
                    renderTasks(contentArea);
                    break;
                case 'automation':
                    renderAutomation(contentArea);
                    break;
            }
        }

        function renderDashboard(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const totalLeads = allRecords.filter(r => r.type === 'lead').length;
            const totalContacts = allRecords.filter(r => r.type === 'contact').length;
            const totalTasks = allRecords.filter(r => r.type === 'task').length;
            const completedTasks = allRecords.filter(r => r.type === 'task' && r.status === 'completed').length;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Total de Leads</span>
                            <span class="text-2xl">üéØ</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${totalLeads}</p>
                    </div>
                    
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Contatos</span>
                            <span class="text-2xl">üë•</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${totalContacts}</p>
                    </div>
                    
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Tarefas</span>
                            <span class="text-2xl">‚úì</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${totalTasks}</p>
                    </div>
                    
                    <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-2">
                            <span class="body-text" style="color: ${textColor}; font-size: ${fontSize}px;">Conclu√≠das</span>
                            <span class="text-2xl">‚úîÔ∏è</span>
                        </div>
                        <p class="text-3xl font-bold" style="color: ${primaryColor};">${completedTasks}</p>
                    </div>
                </div>

                <div class="p-6 rounded-lg" style="background: white; border: 1px solid #e2e8f0;">
                    <h3 class="subtitle-text font-semibold mb-4" style="color: ${textColor}; font-size: ${fontSize * 1.125}px;">Atividade Recente</h3>
                    <div id="recent-activity" class="space-y-3">
                        ${allRecords.length > 0 ? allRecords.slice(-5).reverse().map(record => `
                            <div class="flex items-center justify-between p-3 rounded" style="background: #f8fafc;">
                                <div>
                                    <p class="body-text font-medium" style="color: ${textColor}; font-size: ${fontSize}px;">${record.name}</p>
                                    <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${record.type === 'lead' ? 'üéØ Lead' : record.type === 'contact' ? 'üë• Contato' : '‚úì Tarefa'}</p>
                                </div>
                                <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${new Date(record.createdAt).toLocaleDateString('pt-BR')}</span>
                            </div>
                        `).join('') : `<p class="body-text text-center py-8" style="color: #94a3b8; font-size: ${fontSize}px;">Nenhuma atividade recente. Clique em um dos menus para come√ßar!</p>`}
                    </div>
                </div>
            `;
        }

        function renderMetrics(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const leads = allRecords.filter(r => r.type === 'lead');
            const newLeads = leads.filter(l => l.stage === 'new').length;
            const qualifiedLeads = leads.filter(l => l.stage === 'qualified').length;
            const wonLeads = leads.filter(l => l.stage === 'won').length;
            const totalValue = leads.reduce((sum, l) => sum + (l.value || 0), 0);

            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="subtitle-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                        üìà ${config.metrics_title || defaultConfig.metrics_title}
                    </h3>
                    <p class="body-text" style="color: #64748b; font-size: ${fontSize}px;">Acompanhe o desempenho do seu neg√≥cio</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Novos Leads</span>
                            <span class="text-2xl">üéØ</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">${newLeads}</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚ÜóÔ∏è Pipeline ativo</p>
                    </div>

                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Qualificados</span>
                            <span class="text-2xl">‚úÖ</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">${qualifiedLeads}</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚ÜóÔ∏è Em negocia√ß√£o</p>
                    </div>

                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Ganhos</span>
                            <span class="text-2xl">üèÜ</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">${wonLeads}</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚úì Vendas fechadas</p>
                    </div>

                    <div class="metric-card p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                        <div class="flex items-center justify-between mb-3">
                            <span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Receita Total</span>
                            <span class="text-2xl">üí∞</span>
                        </div>
                        <p class="text-4xl font-bold mb-2" style="color: ${primaryColor};">R$ ${(totalValue/1000).toFixed(0)}k</p>
                        <p class="small-text" style="color: #10b981; font-size: ${fontSize * 0.875}px;">‚ÜóÔ∏è Pipeline value</p>
                    </div>
                </div>
            `;
        }

        function renderLeadsDragDrop(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const leads = allRecords.filter(r => r.type === 'lead');
            const stages = ['new', 'contacted', 'qualified', 'proposal', 'won'];
            const stageNames = {
                'new': 'Novo',
                'contacted': 'Contatado',
                'qualified': 'Qualificado',
                'proposal': 'Proposta',
                'won': 'Ganho'
            };

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <h3 class="subtitle-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                            ÔøΩÔøΩÔøΩ ${config.leads_title || defaultConfig.leads_title}
                        </h3>
                        <p class="body-text" style="color: #64748b; font-size: ${fontSize}px;">Arraste os cards para mudar de est√°gio</p>
                    </div>
                    <button onclick="openModal('lead')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Novo Lead
                    </button>
                </div>

                <div class="flex gap-4 overflow-x-auto pb-4">
                    ${stages.map(stage => {
                        const stageLeads = leads.filter(l => l.stage === stage);
                        const stageValue = stageLeads.reduce((sum, l) => sum + (l.value || 0), 0);
                        return `
                            <div class="flex-shrink-0 w-80">
                                <div class="p-4 rounded-lg mb-3" style="background: white; border: 1px solid #e2e8f0;">
                                    <h4 class="body-text font-semibold mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">${stageNames[stage]}</h4>
                                    <div class="flex items-center justify-between">
                                        <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${stageLeads.length} leads</p>
                                        <p class="small-text font-semibold" style="color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">R$ ${(stageValue/1000).toFixed(0)}k</p>
                                    </div>
                                </div>
                                <div 
                                    class="kanban-column space-y-3 p-3 rounded-lg min-h-96" 
                                    style="background: #f8fafc; border: 2px dashed transparent; transition: all 0.3s;"
                                    data-stage="${stage}"
                                    ondragover="handleDragOver(event)"
                                    ondragleave="handleDragLeave(event)"
                                    ondrop="handleDrop(event, '${stage}')"
                                >
                                    ${stageLeads.map(lead => `
                                        <div 
                                            class="lead-card p-4 rounded-lg card-hover cursor-move" 
                                            style="background: white; border: 1px solid #e2e8f0;"
                                            draggable="true"
                                            data-lead-id="${lead.id}"
                                            ondragstart="handleDragStart(event, '${lead.id}')"
                                            ondragend="handleDragEnd(event)"
                                        >
                                            <div class="flex items-start justify-between mb-2">
                                                <h5 class="body-text font-medium flex-1" style="color: ${textColor}; font-size: ${fontSize}px;">${lead.name}</h5>
                                                <button onclick="event.stopPropagation(); openEditModal('${lead.id}')" class="text-sm px-2 py-1 rounded" style="color: #64748b; background: #f8fafc; font-size: ${fontSize * 0.875}px;">
                                                    ‚öôÔ∏è
                                                </button>
                                            </div>
                                            <p class="small-text mb-2" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${lead.company || 'Sem empresa'}</p>
                                            ${lead.value ? `<p class="small-text font-semibold" style="color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">üí∞ R$ ${lead.value.toLocaleString('pt-BR')}</p>` : ''}
                                            <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-between">
                                                <span class="small-text" style="color: #94a3b8; font-size: ${fontSize * 0.75}px;">üñêÔ∏è Arraste para mover</span>
                                            </div>
                                        </div>
                                    `).join('') || `<p class="text-center text-sm py-8" style="color: #94a3b8; font-size: ${fontSize * 0.875}px;">Nenhum lead<br/>Arraste cards aqui</p>`}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Fun√ß√µes de Drag and Drop
        let draggedLeadId = null;

        function handleDragStart(event, leadId) {
            draggedLeadId = leadId;
            event.currentTarget.classList.add('dragging');
            event.currentTarget.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            event.currentTarget.style.opacity = '1';
            
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.style.border = '2px dashed transparent';
                col.style.background = '#f8fafc';
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const column = event.currentTarget;
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            column.style.border = `2px dashed ${primaryColor}`;
            column.style.background = 'rgba(99, 102, 241, 0.05)';
        }

        function handleDragLeave(event) {
            const column = event.currentTarget;
            column.style.border = '2px dashed transparent';
            column.style.background = '#f8fafc';
        }

        function handleDrop(event, newStage) {
            event.preventDefault();
            
            if (!draggedLeadId) return;
            
            const leadIndex = allRecords.findIndex(r => r.id === draggedLeadId);
            if (leadIndex === -1) return;
            
            const lead = allRecords[leadIndex];
            const oldStage = lead.stage;
            
            lead.stage = newStage;
            lead.updatedAt = new Date().toISOString();
            
            saveLocalData();
            
            const column = event.currentTarget;
            column.style.border = '2px dashed transparent';
            column.style.background = '#f8fafc';
            
            const stageNames = {
                'new': 'Novo',
                'contacted': 'Contatado',
                'qualified': 'Qualificado',
                'proposal': 'Proposta',
                'won': 'Ganho'
            };
            
            if (oldStage !== newStage) {
                showToast(`Lead movido para "${stageNames[newStage]}"! üéØ`, 'success');
            }
            
            updateCurrentView();
            
            draggedLeadId = null;
        }

        function renderCalendar(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            container.innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                            üìÖ ${config.calendar_title || defaultConfig.calendar_title}
                        </h3>
                        <button onclick="openModal('task')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                            + Nova Tarefa
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 rounded-lg mb-4" style="background: white; border: 1px solid #e2e8f0;">
                        <button onclick="changeMonth(-1)" class="p-2 rounded" style="color: ${textColor}; font-size: ${fontSize}px;">
                            ÔøΩÔøΩÔøΩÔøΩ Anterior
                        </button>
                        <h4 class="body-text font-bold" style="color: ${primaryColor}; font-size: ${fontSize}px;">${monthNames[currentMonth]} ${currentYear}</h4>
                        <button onclick="changeMonth(1)" class="p-2 rounded" style="color: ${textColor}; font-size: ${fontSize}px;">
                            Pr√≥ximo ‚Üí
                        </button>
                    </div>
                </div>

                <div class="rounded-lg overflow-hidden" style="background: white; border: 1px solid #e2e8f0;">
                    <div class="calendar-grid" style="background: #f8fafc;">
                        ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].map(day => `
                            <div class="p-4 text-center body-text font-semibold" style="color: ${textColor}; background: white; border-bottom: 2px solid ${primaryColor}; font-size: ${fontSize}px;">
                                ${day}
                            </div>
                        `).join('')}
                    </div>

                    <div class="calendar-grid">
                        ${Array.from({ length: startingDayOfWeek }, () => `
                            <div class="calendar-day p-2" style="background: #f8fafc; border: 1px solid #e2e8f0;"></div>
                        `).join('')}
                        
                        ${Array.from({ length: daysInMonth }, (_, i) => {
                            const day = i + 1;
                            const date = new Date(currentYear, currentMonth, day);
                            const isToday = date.toDateString() === new Date().toDateString();
                            
                            return `
                                <div class="calendar-day p-2" style="background: white; border: 1px solid #e2e8f0; ${isToday ? `border: 2px solid ${primaryColor};` : ''}">
                                    <span class="small-text font-semibold" style="color: ${isToday ? primaryColor : textColor}; font-size: ${fontSize * 0.875}px;">${day}</span>
                                    ${isToday ? `<span class="small-text px-2 py-1 rounded ml-1" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 0.625}px;">Hoje</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCurrentView();
        }

        function renderContacts(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const contacts = allRecords.filter(r => r.type === 'contact');

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                        üë• ${config.contacts_title || defaultConfig.contacts_title}
                    </h3>
                    <button onclick="openModal('contact')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Novo Contato
                    </button>
                </div>

                <div class="rounded-lg overflow-hidden" style="background: white; border: 1px solid #e2e8f0;">
                    <table class="w-full">
                        <thead style="background: #f8fafc;">
                            <tr>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">Nome</th>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">Email</th>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">Telefone</th>
                                <th class="text-left p-4 body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${contacts.map(contact => `
                                <tr class="border-t border-gray-200">
                                    <td class="p-4 body-text" style="color: ${textColor}; font-size: ${fontSize}px;">${contact.name}</td>
                                    <td class="p-4 small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${contact.email || '-'}</td>
                                    <td class="p-4 small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${contact.phone || '-'}</td>
                                    <td class="p-4">
                                        <button onclick="openEditModal('${contact.id}')" class="px-3 py-1 rounded small-text" style="background: #f8fafc; color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                                            Editar
                                        </button>
                                    </td>
                                </tr>
                            `).join('') || `
                                <tr>
                                    <td colspan="4" class="p-8 text-center body-text" style="color: #94a3b8; font-size: ${fontSize}px;">
                                        Nenhum contato cadastrado. Clique em "+ Novo Contato" para come√ßar!
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderTasks(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const tasks = allRecords.filter(r => r.type === 'task');
            const pendingTasks = tasks.filter(t => t.status !== 'completed');
            const completedTasks = tasks.filter(t => t.status === 'completed');

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                        ‚úì ${config.tasks_title || defaultConfig.tasks_title}
                    </h3>
                    <button onclick="openModal('task')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Nova Tarefa
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="p-6 rounded-lg" style="background: white; border: 1px solid #e2e8f0;">
                        <h4 class="body-text font-semibold mb-4" style="color: ${textColor}; font-size: ${fontSize}px;">Pendentes (${pendingTasks.length})</h4>
                        <div class="space-y-3">
                            ${pendingTasks.map(task => `
                                <div class="p-4 rounded-lg" style="background: #f8fafc;">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h5 class="body-text font-medium mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">${task.name}</h5>
                                            ${task.notes ? `<p class="small-text mb-2" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${task.notes}</p>` : ''}
                                            <span class="small-text px-2 py-1 rounded" style="background: ${task.priority === 'high' ? '#fee2e2' : task.priority === 'medium' ? '#fef3c7' : '#f0f9ff'}; color: ${task.priority === 'high' ? '#991b1b' : task.priority === 'medium' ? '#92400e' : '#1e40af'}; font-size: ${fontSize * 0.75}px;">
                                                ${task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'M√©dia' : 'Baixa'}
                                            </span>
                                        </div>
                                        <button onclick="completeTask('${task.id}')" class="ml-3 px-3 py-1 rounded small-text" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 0.875}px;">
                                            Concluir
                                        </button>
                                    </div>
                                </div>
                            `).join('') || `<p class="body-text text-center py-8" style="color: #94a3b8; font-size: ${fontSize}px;">Nenhuma tarefa pendente</p>`}
                        </div>
                    </div>

                    <div class="p-6 rounded-lg" style="background: white; border: 1px solid #e2e8f0;">
                        <h4 class="body-text font-semibold mb-4" style="color: ${textColor}; font-size: ${fontSize}px;">Conclu√≠das (${completedTasks.length})</h4>
                        <div class="space-y-3">
                            ${completedTasks.map(task => `
                                <div class="p-4 rounded-lg" style="background: #f8fafc; opacity: 0.7;">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h5 class="body-text font-medium line-through mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">${task.name}</h5>
                                        </div>
                                        <span class="ml-3 text-xl">‚úì</span>
                                    </div>
                                </div>
                            `).join('') || `<p class="body-text text-center py-8" style="color: #94a3b8; font-size: ${fontSize}px;">Nenhuma tarefa conclu√≠da</p>`}
                        </div>
                    </div>
                </div>
            `;
        }

        function completeTask(id) {
            const task = allRecords.find(r => r.id === id);
            if (!task) return;

            task.status = 'completed';
            task.updatedAt = new Date().toISOString();
            
            saveLocalData();
            showToast('Tarefa conclu√≠da!', 'success');
            updateCurrentView();
        }

        function renderAutomation(container) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const automations = allRecords.filter(r => r.type === 'automation');

            container.innerHTML = `
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <h3 class="subtitle-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 1.25}px;">
                            ‚ö° Automa√ß√£o WhatsApp Avan√ßada
                        </h3>
                        <p class="body-text" style="color: #64748b; font-size: ${fontSize}px;">Sistema profissional com rota√ß√£o de mensagens e prote√ß√£o anti-bloqueio</p>
                    </div>
                    <button onclick="openModal('automation')" class="px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                        + Nova Automa√ß√£o
                    </button>
                </div>

                <div class="mb-8 p-6 rounded-lg" style="background: white; border: 2px solid ${primaryColor};">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">üì±</span>
                        <div>
                            <h4 class="body-text font-semibold mb-1" style="color: ${textColor}; font-size: ${fontSize}px;">WhatsApp Business Pro</h4>
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Sistema completo com rota√ß√£o de mensagens e prote√ß√£o inteligente</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div class="p-3 rounded" style="background: #f0fdf4; border: 1px solid #86efac;">
                            <p class="small-text font-semibold mb-1" style="color: #166534; font-size: ${fontSize * 0.875}px;">‚úÖ Rota√ß√£o de Mensagens</p>
                            <p class="small-text" style="color: #15803d; font-size: ${fontSize * 0.75}px;">At√© 5 mensagens diferentes</p>
                        </div>
                        <div class="p-3 rounded" style="background: #eff6ff; border: 1px solid #93c5fd;">
                            <p class="small-text font-semibold mb-1" style="color: #1e40af; font-size: ${fontSize * 0.875}px;">üîê Anti-Bloqueio</p>
                            <p class="small-text" style="color: #1e3a8a; font-size: ${fontSize * 0.75}px;">Intervalos humanizados</p>
                        </div>
                        <div class="p-3 rounded" style="background: #fef3c7; border: 1px solid #fcd34d;">
                            <p class="small-text font-semibold mb-1" style="color: #92400e; font-size: ${fontSize * 0.875}px;">üìé Anexos</p>
                            <p class="small-text" style="color: #78350f; font-size: ${fontSize * 0.75}px;">Imagens, v√≠deos, docs</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    ${automations.map(auto => {
                        const messages = auto.messages || [];
                        const delayConfig = auto.delayConfig || {};
                        const hasDelay = delayConfig.enabled;
                        
                        return `
                        <div class="p-6 rounded-lg card-hover" style="background: white; border: 1px solid #e2e8f0;">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h5 class="body-text font-semibold" style="color: ${textColor}; font-size: ${fontSize}px;">${auto.name}</h5>
                                        ${hasDelay ? `<span class="small-text px-2 py-1 rounded" style="background: #dcfce7; color: #166534; font-size: ${fontSize * 0.75}px;">üîê Protegido</span>` : ''}
                                    </div>
                                    <p class="small-text mb-3" style="color: #64748b; font-size: ${fontSize * 0.875}px;">${auto.notes || 'Sem descri√ß√£o'}</p>
                                    <div class="flex flex-wrap gap-3 mb-3">
                                        <span class="small-text" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;"><strong>Gatilho:</strong> ${auto.trigger}</span>
                                        <span class="small-text" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;"><strong>Mensagens:</strong> ${messages.length}/5</span>
                                        ${hasDelay ? `<span class="small-text" style="color: #166534; font-size: ${fontSize * 0.875}px;"><strong>‚è±Ô∏è</strong> ${delayConfig.minInterval || 20}-${delayConfig.maxInterval || 45}s</span>` : ''}
                                    </div>
                                    ${messages.length > 0 ? `
                                        <div class="mt-3 p-3 rounded" style="background: #f8fafc; border: 1px solid #e2e8f0;">
                                            <p class="small-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">üì± Mensagens Configuradas:</p>
                                            <div class="space-y-2">
                                                ${messages.map((msg, idx) => `
                                                    <div class="flex items-start gap-2">
                                                        <span class="small-text font-semibold" style="color: ${primaryColor}; font-size: ${fontSize * 0.75}px;">${idx + 1}.</span>
                                                        <div class="flex-1">
                                                            <p class="small-text" style="color: ${textColor}; font-size: ${fontSize * 0.75}px;">${msg.text.substring(0, 60)}${msg.text.length > 60 ? '...' : ''}</p>
                                                            ${msg.attachment ? `<span class="small-text" style="color: #64748b; font-size: ${fontSize * 0.625}px;">${getAttachmentIcon(msg.attachment.type)} ${msg.attachment.type}</span>` : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="openEditModal('${auto.id}')" class="px-3 py-1 rounded small-text" style="background: #f0f9ff; color: #1e40af; font-size: ${fontSize * 0.875}px;">
                                        Editar
                                    </button>
                                    <button onclick="deleteRecord('${auto.id}')" class="px-3 py-1 rounded small-text" style="background: #fee2e2; color: #991b1b; font-size: ${fontSize * 0.875}px;">
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('') || `
                        <div class="p-12 rounded-lg text-center" style="background: white; border: 1px solid #e2e8f0;">
                            <span class="text-6xl mb-4 block">‚ö°</span>
                            <p class="body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;">Nenhuma automa√ß√£o criada</p>
                            <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.875}px;">Crie sua primeira automa√ß√£o profissional com rota√ß√£o de mensagens</p>
                        </div>
                    `}
                </div>
            `;
        }

        function getAttachmentIcon(type) {
            const icons = {
                'image': 'üñºÔ∏è',
                'video': 'üé•',
                'document': 'üìÑ',
                'audio': 'üéµ',
                'location': 'üìç',
                'contact': 'üë§'
            };
            return icons[type] || 'üìé';
        }

        function openModal(type) {
            currentEditRecord = null;
            renderModal(type);
        }

        function openEditModal(id) {
            currentEditRecord = allRecords.find(r => r.id === id);
            if (!currentEditRecord) return;
            renderModal(currentEditRecord.type);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.remove();
        }

        function renderModal(type) {
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;

            const isEdit = currentEditRecord !== null;
            const record = currentEditRecord || {};

            const modalTitle = isEdit ? 
                (type === 'lead' ? 'Editar Lead' : type === 'contact' ? 'Editar Contato' : type === 'task' ? 'Editar Tarefa' : 'Editar Automa√ß√£o') :
                (type === 'lead' ? 'Novo Lead' : type === 'contact' ? 'Novo Contato' : type === 'task' ? 'Nova Tarefa' : 'Nova Automa√ß√£o');

            const existingModal = document.getElementById('modal');
            if (existingModal) existingModal.remove();

            let formFields = '';

            if (type === 'automation') {
                const messages = record.messages || [{ text: '', attachment: null }];
                const delayConfig = record.delayConfig || {
                    enabled: false,
                    beforeStart: 20,
                    minInterval: 20,
                    maxInterval: 45,
                    randomExtra: 6,
                    messagesPerHour: 30
                };
                
                formFields = `
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="name">Nome da Automa√ß√£o</label>
                        <input type="text" id="name" required value="${record.name || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                    </div>
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="trigger">Gatilho</label>
                        <select id="trigger" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                            <option value="Novo lead criado" ${record.trigger === 'Novo lead criado' ? 'selected' : ''}>Novo lead criado</option>
                            <option value="Lead muda de est√°gio" ${record.trigger === 'Lead muda de est√°gio' ? 'selected' : ''}>Lead muda de est√°gio</option>
                            <option value="Contato criado" ${record.trigger === 'Contato criado' ? 'selected' : ''}>Contato criado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="notes">Descri√ß√£o</label>
                        <textarea id="notes" rows="2" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">${record.notes || ''}</textarea>
                    </div>

                    <div class="p-4 rounded-lg" style="background: #f0fdf4; border: 1px solid #86efac;">
                        <h4 class="body-text font-semibold mb-3" style="color: #166534; font-size: ${fontSize}px;">üì± Rota√ß√£o de Mensagens (${messages.length}/5)</h4>
                        <div id="messages-container" class="space-y-4">
                            ${messages.map((msg, idx) => `
                                <div class="message-item p-3 rounded" style="background: white; border: 1px solid #d1fae5;" data-index="${idx}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="small-text font-semibold" style="color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">Mensagem ${idx + 1}</span>
                                        ${messages.length > 1 ? `<button type="button" onclick="removeMessage(${idx})" class="small-text px-2 py-1 rounded" style="background: #fee2e2; color: #991b1b; font-size: ${fontSize * 0.75}px;">Remover</button>` : ''}
                                    </div>
                                    <textarea 
                                        class="message-text w-full p-2 rounded border border-gray-300 mb-2" 
                                        rows="3" 
                                        placeholder="Digite a mensagem ${idx + 1}..." 
                                        style="color: ${textColor}; font-size: ${fontSize * 0.875}px;"
                                    >${msg.text}</textarea>
                                    
                                    <div class="attachment-section">
                                        <p class="small-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">üìé Anexo (Opcional)</p>
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            <button type="button" onclick="selectAttachmentType(${idx}, 'image')" class="attachment-btn px-3 py-1 rounded small-text" style="background: ${msg.attachment?.type === 'image' ? primaryColor : '#f1f5f9'}; color: ${msg.attachment?.type === 'image' ? 'white' : textColor}; font-size: ${fontSize * 0.75}px;">üñºÔ∏è Imagem</button>
                                            <button type="button" onclick="selectAttachmentType(${idx}, 'video')" class="attachment-btn px-3 py-1 rounded small-text" style="background: ${msg.attachment?.type === 'video' ? primaryColor : '#f1f5f9'}; color: ${msg.attachment?.type === 'video' ? 'white' : textColor}; font-size: ${fontSize * 0.75}px;">üé• V√≠deo</button>
                                            <button type="button" onclick="selectAttachmentType(${idx}, 'document')" class="attachment-btn px-3 py-1 rounded small-text" style="background: ${msg.attachment?.type === 'document' ? primaryColor : '#f1f5f9'}; color: ${msg.attachment?.type === 'document' ? 'white' : textColor}; font-size: ${fontSize * 0.75}px;">üìÑ Doc</button>
                                            <button type="button" onclick="selectAttachmentType(${idx}, 'audio')" class="attachment-btn px-3 py-1 rounded small-text" style="background: ${msg.attachment?.type === 'audio' ? primaryColor : '#f1f5f9'}; color: ${msg.attachment?.type === 'audio' ? 'white' : textColor}; font-size: ${fontSize * 0.75}px;">üéµ √Åudio</button>
                                            <button type="button" onclick="selectAttachmentType(${idx}, 'location')" class="attachment-btn px-3 py-1 rounded small-text" style="background: ${msg.attachment?.type === 'location' ? primaryColor : '#f1f5f9'}; color: ${msg.attachment?.type === 'location' ? 'white' : textColor}; font-size: ${fontSize * 0.75}px;">üìç Local</button>
                                            <button type="button" onclick="selectAttachmentType(${idx}, 'contact')" class="attachment-btn px-3 py-1 rounded small-text" style="background: ${msg.attachment?.type === 'contact' ? primaryColor : '#f1f5f9'}; color: ${msg.attachment?.type === 'contact' ? 'white' : textColor}; font-size: ${fontSize * 0.75}px;">üë§ Contato</button>
                                        </div>
                                        <div id="attachment-fields-${idx}" class="attachment-fields space-y-2">
                                            ${msg.attachment ? renderAttachmentFields(idx, msg.attachment, textColor, fontSize) : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${messages.length < 5 ? `
                            <button type="button" onclick="addMessage()" class="w-full mt-3 p-2 rounded body-text" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 0.875}px;">
                                + Adicionar Mensagem (${messages.length}/5)
                            </button>
                        ` : `
                            <p class="text-center mt-3 small-text" style="color: #166534; font-size: ${fontSize * 0.875}px;">‚úì M√°ximo de 5 mensagens atingido</p>
                        `}
                    </div>

                    <div class="p-4 rounded-lg" style="background: #eff6ff; border: 1px solid #93c5fd;">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="body-text font-semibold" style="color: #1e40af; font-size: ${fontSize}px;">üîê Prote√ß√£o Anti-Bloqueio</h4>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="delay-enabled" ${delayConfig.enabled ? 'checked' : ''} onchange="toggleDelayConfig(this.checked)" class="w-5 h-5">
                                <span class="small-text" style="color: #1e40af; font-size: ${fontSize * 0.875}px;">Ativar</span>
                            </label>
                        </div>
                        <div id="delay-config" style="display: ${delayConfig.enabled ? 'block' : 'none'};">
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block small-text mb-1" style="color: #1e40af; font-size: ${fontSize * 0.875}px;">‚è∞ Aguardar antes (s)</label>
                                    <input type="number" id="delay-before" value="${delayConfig.beforeStart}" min="10" max="60" class="w-full p-2 rounded border border-gray-300" style="font-size: ${fontSize * 0.875}px;">
                                </div>
                                <div>
                                    <label class="block small-text mb-1" style="color: #1e40af; font-size: ${fontSize * 0.875}px;">‚è±Ô∏è Intervalo Min (s)</label>
                                    <input type="number" id="delay-min" value="${delayConfig.minInterval}" min="15" max="120" class="w-full p-2 rounded border border-gray-300" style="font-size: ${fontSize * 0.875}px;">
                                </div>
                                <div>
                                    <label class="block small-text mb-1" style="color: #1e40af; font-size: ${fontSize * 0.875}px;">‚è±Ô∏è Intervalo Max (s)</label>
                                    <input type="number" id="delay-max" value="${delayConfig.maxInterval}" min="20" max="180" class="w-full p-2 rounded border border-gray-300" style="font-size: ${fontSize * 0.875}px;">
                                </div>
                                <div>
                                    <label class="block small-text mb-1" style="color: #1e40af; font-size: ${fontSize * 0.875}px;">üé≤ Extra Aleat√≥rio (s)</label>
                                    <input type="number" id="delay-random" value="${delayConfig.randomExtra}" min="3" max="15" class="w-full p-2 rounded border border-gray-300" style="font-size: ${fontSize * 0.875}px;">
                                </div>
                            </div>
                            <div>
                                <label class="block small-text mb-1" style="color: #1e40af; font-size: ${fontSize * 0.875}px;">üìä Limite por Hora</label>
                                <input type="number" id="delay-per-hour" value="${delayConfig.messagesPerHour}" min="10" max="60" class="w-full p-2 rounded border border-gray-300" style="font-size: ${fontSize * 0.875}px;">
                                <p class="small-text mt-1" style="color: #64748b; font-size: ${fontSize * 0.75}px;">Recomendado: 20-40 mensagens/hora</p>
                            </div>
                            <div class="mt-3 p-2 rounded" style="background: #fef3c7; border: 1px solid #fcd34d;">
                                <p class="small-text" style="color: #92400e; font-size: ${fontSize * 0.75}px;">
                                    ‚ö†Ô∏è <strong>Como funciona:</strong> Sistema aguarda ${delayConfig.beforeStart}s antes de come√ßar, envia primeira mensagem, aguarda ${delayConfig.minInterval}-${delayConfig.maxInterval}s + ${delayConfig.randomExtra}s aleat√≥rios, depois envia pr√≥xima mensagem. Limite: ${delayConfig.messagesPerHour} msgs/hora.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                formFields = `
                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="name">Nome</label>
                        <input type="text" id="name" required value="${record.name || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                    </div>

                    ${type !== 'task' ? `
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="email">Email</label>
                            <input type="email" id="email" value="${record.email || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="phone">Telefone</label>
                            <input type="tel" id="phone" value="${record.phone || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="company">Empresa</label>
                            <input type="text" id="company" value="${record.company || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                    ` : ''}

                    ${type === 'lead' ? `
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="value">Valor (R$)</label>
                            <input type="number" id="value" value="${record.value || ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="stage">Est√°gio</label>
                            <select id="stage" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                                <option value="new" ${record.stage === 'new' ? 'selected' : ''}>Novo</option>
                                <option value="contacted" ${record.stage === 'contacted' ? 'selected' : ''}>Contatado</option>
                                <option value="qualified" ${record.stage === 'qualified' ? 'selected' : ''}>Qualificado</option>
                                <option value="proposal" ${record.stage === 'proposal' ? 'selected' : ''}>Proposta</option>
                                <option value="won" ${record.stage === 'won' ? 'selected' : ''}>Ganho</option>
                            </select>
                        </div>
                    ` : ''}

                    ${type === 'task' ? `
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="priority">Prioridade</label>
                            <select id="priority" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                                <option value="low" ${record.priority === 'low' ? 'selected' : ''}>Baixa</option>
                                <option value="medium" ${record.priority === 'medium' ? 'selected' : ''}>M√©dia</option>
                                <option value="high" ${record.priority === 'high' ? 'selected' : ''}>Alta</option>
                            </select>
                        </div>
                        <div>
                            <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="dueDate">Data de Vencimento</label>
                            <input type="date" id="dueDate" value="${record.dueDate ? new Date(record.dueDate).toISOString().split('T')[0] : ''}" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">
                        </div>
                    ` : ''}

                    <div>
                        <label class="block body-text mb-2" style="color: ${textColor}; font-size: ${fontSize}px;" for="notes">Observa√ß√µes</label>
                        <textarea id="notes" rows="3" class="w-full p-3 rounded-lg border border-gray-300" style="color: ${textColor}; font-size: ${fontSize}px;">${record.notes || ''}</textarea>
                    </div>
                `;
            }

            const modalHTML = `
                <div id="modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4" style="z-index: 1000;" onclick="if(event.target.id==='modal') closeModal()">
                    <div class="rounded-lg p-6 w-full max-w-md slide-in" style="background: white; max-height: 90%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="subtitle-text font-semibold" style="color: ${textColor}; font-size: ${fontSize * 1.125}px;">${modalTitle}</h3>
                            <button onclick="closeModal()" class="text-2xl" style="color: #64748b;">&times;</button>
                        </div>

                        <form id="record-form" class="space-y-4" onsubmit="event.preventDefault(); saveRecord('${type}');">
                            ${formFields}

                            <div class="flex gap-3 pt-4">
                                ${isEdit ? `
                                    <button type="button" onclick="deleteRecord('${record.id}')" class="px-4 py-2 rounded-lg body-text" style="background: #fee2e2; color: #991b1b; font-size: ${fontSize}px;">
                                        Excluir
                                    </button>
                                ` : ''}
                                <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 rounded-lg body-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize}px;">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 rounded-lg body-text font-medium" style="background: ${primaryColor}; color: white; font-size: ${fontSize}px;">
                                    ${isEdit ? 'Salvar' : 'Criar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function saveRecord(type) {
            const formData = {
                type,
                id: currentEditRecord?.id || `${type}_${Date.now()}`,
                name: document.getElementById('name').value,
                createdAt: currentEditRecord?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (type === 'automation') {
                // Coletar todas as mensagens
                const messageItems = document.querySelectorAll('.message-item');
                const messages = [];
                messageItems.forEach((item, idx) => {
                    const text = item.querySelector('.message-text').value;
                    const attachmentType = item.querySelector('.attachment-fields')?.dataset.attachmentType;
                    
                    let attachment = null;
                    if (attachmentType) {
                        attachment = { type: attachmentType };
                        
                        if (attachmentType === 'image' || attachmentType === 'video' || attachmentType === 'document') {
                            attachment.url = document.getElementById(`attachment-url-${idx}`)?.value || '';
                            attachment.caption = document.getElementById(`attachment-caption-${idx}`)?.value || '';
                        } else if (attachmentType === 'audio') {
                            attachment.url = document.getElementById(`attachment-url-${idx}`)?.value || '';
                        } else if (attachmentType === 'location') {
                            attachment.latitude = document.getElementById(`attachment-lat-${idx}`)?.value || '';
                            attachment.longitude = document.getElementById(`attachment-lng-${idx}`)?.value || '';
                            attachment.name = document.getElementById(`attachment-name-${idx}`)?.value || '';
                            attachment.address = document.getElementById(`attachment-address-${idx}`)?.value || '';
                        } else if (attachmentType === 'contact') {
                            attachment.name = document.getElementById(`attachment-name-${idx}`)?.value || '';
                            attachment.phone = document.getElementById(`attachment-phone-${idx}`)?.value || '';
                            attachment.email = document.getElementById(`attachment-email-${idx}`)?.value || '';
                        }
                    }
                    
                    messages.push({ text, attachment });
                });
                
                // Coletar configura√ß√£o de delay
                const delayEnabled = document.getElementById('delay-enabled')?.checked || false;
                const delayConfig = {
                    enabled: delayEnabled,
                    beforeStart: parseInt(document.getElementById('delay-before')?.value) || 20,
                    minInterval: parseInt(document.getElementById('delay-min')?.value) || 20,
                    maxInterval: parseInt(document.getElementById('delay-max')?.value) || 45,
                    randomExtra: parseInt(document.getElementById('delay-random')?.value) || 6,
                    messagesPerHour: parseInt(document.getElementById('delay-per-hour')?.value) || 30
                };
                
                formData.trigger = document.getElementById('trigger').value;
                formData.notes = document.getElementById('notes').value;
                formData.messages = messages;
                formData.delayConfig = delayConfig;
            } else {
                formData.email = document.getElementById('email')?.value || '';
                formData.phone = document.getElementById('phone')?.value || '';
                formData.company = document.getElementById('company')?.value || '';
                formData.value = parseFloat(document.getElementById('value')?.value) || 0;
                formData.stage = document.getElementById('stage')?.value || 'new';
                formData.priority = document.getElementById('priority')?.value || 'medium';
                formData.notes = document.getElementById('notes').value;
                formData.status = 'active';
                formData.dueDate = document.getElementById('dueDate')?.value ? new Date(document.getElementById('dueDate').value).toISOString() : '';
            }

            if (currentEditRecord) {
                const index = allRecords.findIndex(r => r.id === currentEditRecord.id);
                if (index !== -1) {
                    allRecords[index] = formData;
                }
            } else {
                allRecords.push(formData);
            }

            saveLocalData();
            showToast(currentEditRecord ? 'Registro atualizado!' : 'Registro criado!', 'success');
            closeModal();
            updateCurrentView();
        }

        function addMessage() {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            const messageItems = container.querySelectorAll('.message-item');
            if (messageItems.length >= 5) {
                showToast('M√°ximo de 5 mensagens atingido', 'error');
                return;
            }
            
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;
            const idx = messageItems.length;
            
            const newMessageHTML = `
                <div class="message-item p-3 rounded" style="background: white; border: 1px solid #d1fae5;" data-index="${idx}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="small-text font-semibold" style="color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">Mensagem ${idx + 1}</span>
                        <button type="button" onclick="removeMessage(${idx})" class="small-text px-2 py-1 rounded" style="background: #fee2e2; color: #991b1b; font-size: ${fontSize * 0.75}px;">Remover</button>
                    </div>
                    <textarea 
                        class="message-text w-full p-2 rounded border border-gray-300 mb-2" 
                        rows="3" 
                        placeholder="Digite a mensagem ${idx + 1}..." 
                        style="color: ${textColor}; font-size: ${fontSize * 0.875}px;"
                    ></textarea>
                    
                    <div class="attachment-section">
                        <p class="small-text font-semibold mb-2" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">üìé Anexo (Opcional)</p>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" onclick="selectAttachmentType(${idx}, 'image')" class="attachment-btn px-3 py-1 rounded small-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize * 0.75}px;">üñºÔ∏è Imagem</button>
                            <button type="button" onclick="selectAttachmentType(${idx}, 'video')" class="attachment-btn px-3 py-1 rounded small-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize * 0.75}px;">üé• V√≠deo</button>
                            <button type="button" onclick="selectAttachmentType(${idx}, 'document')" class="attachment-btn px-3 py-1 rounded small-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize * 0.75}px;">üìÑ Doc</button>
                            <button type="button" onclick="selectAttachmentType(${idx}, 'audio')" class="attachment-btn px-3 py-1 rounded small-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize * 0.75}px;">üéµ √Åudio</button>
                            <button type="button" onclick="selectAttachmentType(${idx}, 'location')" class="attachment-btn px-3 py-1 rounded small-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize * 0.75}px;">üìç Local</button>
                            <button type="button" onclick="selectAttachmentType(${idx}, 'contact')" class="attachment-btn px-3 py-1 rounded small-text" style="background: #f1f5f9; color: ${textColor}; font-size: ${fontSize * 0.75}px;">üë§ Contato</button>
                        </div>
                        <div id="attachment-fields-${idx}" class="attachment-fields space-y-2"></div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newMessageHTML);
            
            // Atualizar o bot√£o de adicionar
            const addButton = container.nextElementSibling;
            if (messageItems.length + 1 >= 5 && addButton) {
                addButton.outerHTML = `<p class="text-center mt-3 small-text" style="color: #166534; font-size: ${fontSize * 0.875}px;">‚úì M√°ximo de 5 mensagens atingido</p>`;
            } else if (addButton && addButton.tagName === 'BUTTON') {
                addButton.innerHTML = `+ Adicionar Mensagem (${messageItems.length + 1}/5)`;
            }
            
            showToast('Mensagem adicionada!', 'success');
        }

        function removeMessage(idx) {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            const messageItems = container.querySelectorAll('.message-item');
            if (messageItems.length <= 1) {
                showToast('Necess√°rio pelo menos 1 mensagem', 'error');
                return;
            }
            
            messageItems[idx].remove();
            
            // Reindexar mensagens
            const remainingItems = container.querySelectorAll('.message-item');
            remainingItems.forEach((item, newIdx) => {
                item.dataset.index = newIdx;
                const label = item.querySelector('.small-text.font-semibold');
                if (label) {
                    label.textContent = `Mensagem ${newIdx + 1}`;
                }
            });
            
            // Atualizar bot√£o de adicionar se necess√°rio
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const fontSize = config.font_size || defaultConfig.font_size;
            
            const nextElement = container.nextElementSibling;
            if (remainingItems.length < 5 && nextElement && nextElement.tagName === 'P') {
                nextElement.outerHTML = `
                    <button type="button" onclick="addMessage()" class="w-full mt-3 p-2 rounded body-text" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 0.875}px;">
                        + Adicionar Mensagem (${remainingItems.length}/5)
                    </button>
                `;
            }
            
            showToast('Mensagem removida', 'success');
        }

        function toggleDelayConfig(enabled) {
            const delayConfig = document.getElementById('delay-config');
            if (delayConfig) {
                delayConfig.style.display = enabled ? 'block' : 'none';
            }
        }

        function selectAttachmentType(idx, type) {
            const config = window.elementSdk?.config || defaultConfig;
            const textColor = config.text_color || defaultConfig.text_color;
            const fontSize = config.font_size || defaultConfig.font_size;
            
            const fieldsContainer = document.getElementById(`attachment-fields-${idx}`);
            if (!fieldsContainer) return;
            
            // Atualizar bot√µes
            const messageItem = fieldsContainer.closest('.message-item');
            const buttons = messageItem.querySelectorAll('.attachment-btn');
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            
            buttons.forEach(btn => {
                btn.style.background = '#f1f5f9';
                btn.style.color = textColor;
            });
            
            const selectedBtn = Array.from(buttons).find(btn => btn.textContent.includes(getAttachmentIcon(type)));
            if (selectedBtn) {
                selectedBtn.style.background = primaryColor;
                selectedBtn.style.color = 'white';
            }
            
            fieldsContainer.dataset.attachmentType = type;
            fieldsContainer.innerHTML = renderAttachmentFields(idx, { type }, textColor, fontSize);
        }

        function renderAttachmentFields(idx, attachment, textColor, fontSize) {
            const type = attachment.type;
            const config = window.elementSdk?.config || defaultConfig;
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            
            if (type === 'image') {
                return `
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <button type="button" onclick="document.getElementById('file-input-${idx}').click()" class="flex-1 p-2 rounded border-2 border-dashed text-center" style="border-color: ${primaryColor}; color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">
                                üìÅ Selecionar Arquivo
                            </button>
                        </div>
                        <input type="file" id="file-input-${idx}" accept="image/jpeg,image/png" onchange="handleFileSelect(${idx}, event)" style="display: none;">
                        <input type="url" id="attachment-url-${idx}" value="${attachment.url || ''}" placeholder="Ou cole URL da imagem (https://...)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                        <div id="file-preview-${idx}" class="text-center p-2 rounded" style="background: #f0fdf4; display: ${attachment.fileName ? 'block' : 'none'};">
                            <p class="small-text" style="color: #166534; font-size: ${fontSize * 0.75}px;">‚úì ${attachment.fileName || 'Arquivo selecionado'}</p>
                        </div>
                        <input type="text" id="attachment-caption-${idx}" value="${attachment.caption || ''}" placeholder="Legenda (opcional)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                        <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.75}px;">üíæ Limite: 5MB (JPG, PNG)</p>
                    </div>
                `;
            } else if (type === 'video') {
                return `
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <button type="button" onclick="document.getElementById('file-input-${idx}').click()" class="flex-1 p-2 rounded border-2 border-dashed text-center" style="border-color: ${primaryColor}; color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">
                                üìÅ Selecionar Arquivo
                            </button>
                        </div>
                        <input type="file" id="file-input-${idx}" accept="video/mp4,video/3gpp" onchange="handleFileSelect(${idx}, event)" style="display: none;">
                        <input type="url" id="attachment-url-${idx}" value="${attachment.url || ''}" placeholder="Ou cole URL do v√≠deo (https://...)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                        <div id="file-preview-${idx}" class="text-center p-2 rounded" style="background: #f0fdf4; display: ${attachment.fileName ? 'block' : 'none'};">
                            <p class="small-text" style="color: #166534; font-size: ${fontSize * 0.75}px;">‚úì ${attachment.fileName || 'Arquivo selecionado'}</p>
                        </div>
                        <input type="text" id="attachment-caption-${idx}" value="${attachment.caption || ''}" placeholder="Legenda (opcional)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                        <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.75}px;">üíæ Limite: 16MB (MP4, 3GP)</p>
                    </div>
                `;
            } else if (type === 'document') {
                return `
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <button type="button" onclick="document.getElementById('file-input-${idx}').click()" class="flex-1 p-2 rounded border-2 border-dashed text-center" style="border-color: ${primaryColor}; color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">
                                üìÅ Selecionar Arquivo
                            </button>
                        </div>
                        <input type="file" id="file-input-${idx}" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" onchange="handleFileSelect(${idx}, event)" style="display: none;">
                        <input type="url" id="attachment-url-${idx}" value="${attachment.url || ''}" placeholder="Ou cole URL do documento (https://...)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                        <div id="file-preview-${idx}" class="text-center p-2 rounded" style="background: #f0fdf4; display: ${attachment.fileName ? 'block' : 'none'};">
                            <p class="small-text" style="color: #166534; font-size: ${fontSize * 0.75}px;">‚úì ${attachment.fileName || 'Arquivo selecionado'}</p>
                        </div>
                        <input type="text" id="attachment-caption-${idx}" value="${attachment.caption || ''}" placeholder="Legenda (opcional)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                        <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.75}px;">üíæ Limite: 100MB (PDF, DOC, XLS, PPT)</p>
                    </div>
                `;
            } else if (type === 'audio') {
                return `
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <button type="button" onclick="document.getElementById('file-input-${idx}').click()" class="flex-1 p-2 rounded border-2 border-dashed text-center" style="border-color: ${primaryColor}; color: ${primaryColor}; font-size: ${fontSize * 0.875}px;">
                                üìÅ Selecionar Arquivo
                            </button>
                        </div>
                        <input type="file" id="file-input-${idx}" accept="audio/mpeg,audio/ogg" onchange="handleFileSelect(${idx}, event)" style="display: none;">
                        <input type="url" id="attachment-url-${idx}" value="${attachment.url || ''}" placeholder="Ou cole URL do √°udio (https://...)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                        <div id="file-preview-${idx}" class="text-center p-2 rounded" style="background: #f0fdf4; display: ${attachment.fileName ? 'block' : 'none'};">
                            <p class="small-text" style="color: #166534; font-size: ${fontSize * 0.75}px;">‚úì ${attachment.fileName || 'Arquivo selecionado'}</p>
                        </div>
                        <p class="small-text" style="color: #64748b; font-size: ${fontSize * 0.75}px;">üíæ Limite: 16MB (MP3, OGG)</p>
                    </div>
                `;
            } else if (type === 'location') {
                return `
                    <input type="text" id="attachment-lat-${idx}" value="${attachment.latitude || ''}" placeholder="Latitude (obrigat√≥rio)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                    <input type="text" id="attachment-lng-${idx}" value="${attachment.longitude || ''}" placeholder="Longitude (obrigat√≥rio)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                    <input type="text" id="attachment-name-${idx}" value="${attachment.name || ''}" placeholder="Nome do local (opcional)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                    <input type="text" id="attachment-address-${idx}" value="${attachment.address || ''}" placeholder="Endere√ßo (opcional)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                `;
            } else if (type === 'contact') {
                return `
                    <input type="text" id="attachment-name-${idx}" value="${attachment.name || ''}" placeholder="Nome completo (obrigat√≥rio)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                    <input type="tel" id="attachment-phone-${idx}" value="${attachment.phone || ''}" placeholder="Telefone (obrigat√≥rio)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                    <input type="email" id="attachment-email-${idx}" value="${attachment.email || ''}" placeholder="Email (opcional)" class="w-full p-2 rounded border border-gray-300" style="color: ${textColor}; font-size: ${fontSize * 0.875}px;">
                `;
            }
            
            return '';
        }

        function handleFileSelect(idx, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById(`file-preview-${idx}`);
            const urlInput = document.getElementById(`attachment-url-${idx}`);
            
            // Converter arquivo para Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                // Armazenar no campo URL (Base64)
                if (urlInput) {
                    urlInput.value = base64Data;
                }
                
                // Mostrar preview
                if (preview) {
                    preview.style.display = 'block';
                    preview.innerHTML = `
                        <p class="small-text" style="color: #166534; font-size: 12px;">
                            ‚úì ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                        </p>
                    `;
                }
                
                showToast(`Arquivo "${file.name}" carregado!`, 'success');
            };
            
            reader.onerror = function() {
                showToast('Erro ao carregar arquivo', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        function deleteRecord(id) {
            allRecords = allRecords.filter(r => r.id !== id);
            saveLocalData();
            showToast('Registro exclu√≠do', 'success');
            closeModal();
            updateCurrentView();
        }

        function showToast(message, type = 'success') {
            const bgColor = type === 'success' ? '#10b981' : '#ef4444';
            const config = window.elementSdk?.config || defaultConfig;
            const fontSize = config.font_size || defaultConfig.font_size;
            
            const toast = document.createElement('div');
            toast.className = 'toast body-text';
            toast.style.background = bgColor;
            toast.style.color = 'white';
            toast.style.fontSize = `${fontSize}px`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Sistema de inicializa√ß√£o m√∫ltiplo para garantir carregamento
        let initAttempts = 0;
        const maxAttempts = 3;

        function tryInit() {
            if (appInitialized) return;
            
            initAttempts++;
            
            try {
                initializeApp();
            } catch (error) {
                console.error(`Tentativa ${initAttempts} falhou:`, error);
                
                if (initAttempts < maxAttempts) {
                    setTimeout(tryInit, 100);
                } else {
                    // Mostrar erro ap√≥s todas as tentativas
                    const loader = document.getElementById('app-loading');
                    const app = document.getElementById('app');
                    
                    if (loader) loader.style.display = 'none';
                    if (app) {
                        app.style.display = 'flex';
                        app.innerHTML = `
                            <div style="padding: 40px; text-align: center; width: 100%;">
                                <h1 style="color: #ef4444; margin-bottom: 20px;">‚ùå Erro ao Carregar</h1>
                                <p style="color: #64748b; margin-bottom: 20px;">O CRM n√£o conseguiu inicializar ap√≥s ${maxAttempts} tentativas.</p>
                                <button onclick="location.reload()" style="padding: 12px 24px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                    üîÑ Recarregar P√°gina
                                </button>
                            </div>
                        `;
                    }
                }
            }
        }

        // M√∫ltiplos pontos de inicializa√ß√£o
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryInit);
        } else {
            tryInit();
        }

        window.addEventListener('load', tryInit);
        
        // Fallback final ap√≥s 2 segundos
        setTimeout(tryInit, 2000);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b7dbac3f361a5e7',t:'MTc2NzM5MzMyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
